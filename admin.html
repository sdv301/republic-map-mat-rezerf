<!-- admin.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ - –ö–∞—Ä—Ç–∞ –Ø–∫—É—Ç–∏–∏</title>
  <style>
    body { 
      font-family: -apple-system, system-ui, sans-serif; 
      background: #f0f2f5; 
      margin: 0; 
      padding: 20px;
      color: #1c1e21;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
    }
    .block { 
      background: #fff; 
      padding: 25px; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h2 { margin-top: 0; color: #1a73e8; font-size: 1.2rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    
    .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 200px; display: flex; flex-direction: column; }
    label { font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; color: #4b4f56; }
    
    input, select { 
      padding: 8px 12px; 
      border: 1px solid #dddfe2; 
      border-radius: 4px; 
      font-size: 1rem;
    }
    
    button { 
      padding: 10px 20px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-weight: 600;
      transition: background 0.2s;
    }
    .btn-save { background: #42b72a; color: #fff; }
    .btn-save:hover { background: #36a420; }
    
    .btn-excel { background: #1a73e8; color: #fff; }
    .btn-excel:hover { background: #1557b0; }

    .btn-outline { background: #fff; border: 1px solid #ddd; color: #4b4f56; }
    .btn-outline:hover { background: #f5f6f7; }

    #status { 
      position: fixed; 
      top: 20px; 
      right: 20px; 
      padding: 15px 25px; 
      border-radius: 4px; 
      color: #fff; 
      display: none;
      z-index: 1000;
    }
    .status-ok { background: #42b72a; }
    .status-err { background: #fa3e3e; }
  </style>
</head>
<body>

<div class="container">
  <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>

  <!-- –†–£–ß–ù–û–ô –í–í–û–î -->
  <div class="block">
    <h2>üìù –í–Ω–µ—Å–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h2>
    <div class="form-row">
      <div class="form-group">
        <label>–†–∞–π–æ–Ω</label>
        <select id="districtId"></select>
      </div>
      <div class="form-group">
        <label>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</label>
        <select id="indicatorId"></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>–î–∞—Ç–∞</label>
        <input type="date" id="date" value="2024-01-01">
      </div>
      <div class="form-group">
        <label>–ó–Ω–∞—á–µ–Ω–∏–µ</label>
        <input type="number" id="value" step="0.01">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>–ò—Å—Ç–æ—á–Ω–∏–∫</label>
        <input type="text" id="source" placeholder="–ù–∞–ø—Ä: –†–æ—Å—Å—Ç–∞—Ç">
      </div>
    </div>
    <button class="btn-save" onclick="saveData()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑—É</button>
  </div>

  <!-- EXCEL -->
  <div class="block">
    <h2>üìä –†–∞–±–æ—Ç–∞ —Å Excel</h2>
    <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 20px;">
      <div class="form-group">
        <label>–§–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</label>
        <input type="file" id="excelFile" accept=".xlsx">
      </div>
      <button class="btn-excel" onclick="importExcel()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>
    <hr>
    <div class="form-row" style="margin-top: 20px;">
      <div class="form-group">
        <label>–° –¥–∞—Ç—ã</label>
        <input type="date" id="start">
      </div>
      <div class="form-group">
        <label>–ü–æ –¥–∞—Ç—É</label>
        <input type="date" id="end">
      </div>
    </div>
    <div style="display: flex; gap: 10px;">
      <button class="btn-outline" onclick="exportExcel()">–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç (Excel)</button>
      <button class="btn-outline" onclick="location.href='/api/download-template'">–°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω</button>
    </div>
  </div>
</div>

<div id="status"></div>

<script>
  const API = 'http://localhost:5000/api';

  async function loadSelectors() {
    try {
      const [distRes, indRes] = await Promise.all([
        fetch(`${API}/districts`),
        fetch(`${API}/indicators`)
      ]);
      
      const districts = await distRes.json();
      const indicators = await indRes.json();

      document.getElementById('districtId').innerHTML = districts
        .map(d => `<option value="${d.id}">${d.name}</option>`).join('');
      
      document.getElementById('indicatorId').innerHTML = indicators
        .map(i => `<option value="${i.id}">${i.category} - ${i.name} (${i.unit})</option>`).join('');
    } catch (e) {
      notify('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤', true);
    }
  }

  async function saveData() {
    const data = {
      district_id: document.getElementById('districtId').value,
      indicator_id: parseInt(document.getElementById('indicatorId').value),
      date: document.getElementById('date').value,
      value: parseFloat(document.getElementById('value').value),
      source: document.getElementById('source').value
    };

    if (!data.value) return notify('–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ', true);

    try {
      const res = await fetch(`${API}/data`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (res.ok) {
        notify('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        document.getElementById('value').value = '';
      }
    } catch (e) {
      notify('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', true);
    }
  }

  async function importExcel() {
    const file = document.getElementById('excelFile').files[0];
    if (!file) return notify('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', true);

    const fd = new FormData();
    fd.append('file', file);

    try {
      const res = await fetch(`${API}/upload-excel`, { method: 'POST', body: fd });
      const result = await res.json();
      if (result.success) notify(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.count}`);
    } catch (e) {
      notify('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞', true);
    }
  }

  function exportExcel() {
    const s = document.getElementById('start').value;
    const e = document.getElementById('end').value;
    window.location.href = `${API}/export-excel?startDate=${s}&endDate=${e}`;
  }

  function notify(text, isErr = false) {
    const el = document.getElementById('status');
    el.innerText = text;
    el.className = isErr ? 'status-err' : 'status-ok';
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 3000);
  }

  loadSelectors();
</script>

</body>
</html>
