import { useEffect, useState } from 'react';
import { MapContainer, TileLayer, GeoJSON, Marker, useMap } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';

// Центроиды районов (рассчитаны из твоего GeoJSON — lon, lat перевернуты для Leaflet [lat, lon])
const centroids = {
  'Абыйский район': [67.56601963353482, 143.55304865273894],
  'Алданский район': [59.29690528563522, 127.04733612255535],
  'Таттинский район': [61.6852292881734, 134.68601547664142],
  'Аллаиховский район': [71.22619810977939, 146.70078488626936],
  'Амгинский район': [60.67095994924731, 129.32837891462367],
  'Анабарский район': [71.9886845895544, 115.24337104893193],
  'Булунский район': [70.3576251307758, 125.24107371483326],
  'Верхневилюйский район': [63.11335979429753, 120.70918065078743],
  'Верхнеколымский район': [66.25646206583855, 149.40657246348886],
  'Верхоянский район': [67.64514092112192, 133.75485098988332],
  'Вилюйский район': [64.41626241073679, 121.8038271762257],
  'Горный район': [62.598260032173506, 124.60345298493526],
  'Жиганский район': [68.22445575468755, 120.80520647106393],
  'Кобяйский район': [64.24717016356597, 126.89785547850096],
  'Нюрбинский район': [64.14365160895262, 117.65773888554403],
  'Ленский район': [60.36516745606095, 114.82551668393222],
  'Мегино-Кангаласский район': [61.6323841065134, 130.90581906666665],
  'Мирнинский район': [63.89717456619726, 111.55405377927435],
  'Момский район': [66.31518366770531, 145.22100394164255],
  'Намский район': [62.84356503034434, 128.25058472374462],
  'Нижнеколымский район': [69.10050050142746, 155.59217425649788],
  'Оймяконский район': [63.702031329446335, 141.86714007481228],
  'Олёкминский район': [60.28145646582037, 122.1215592227106],
  'Оленёкский район': [69.60346744372099, 117.08471874474282],
  'Хангаласский район': [60.77676914794035, 125.8057706525568],
  'Среднеколымский район': [68.00852937772407, 153.7188654529485],
  'Сунтарский район': [62.717618576438056, 117.139175768077],
  'Томпонский район': [63.9169542881922, 138.50063772414094],
  'Усть-Алданский район': [63.37707210689166, 132.50463079044405],
  'Усть-Майский район': [61.298878265358944, 135.76254724479602],
  'Усть-Янский район': [69.75350385067274, 137.68716301682633],
  'Чурапчинский район': [61.366487781473346, 133.72628966070315],
  'Эвено-Бытантайский район': [68.08143736258637, 130.77104868313796],
  'Нерюнгринский район': [57.14265617463565, 124.92629173896681],
  'город Якутск': [62.13080740049019, 129.68501229166665],
  'Жатай': [62.14160881730769, 129.79873687948717]
};

// Компонент для установки границ
function SetBounds({ bounds }) {
  const map = useMap();
  useEffect(() => {
    if (bounds) {
      map.setMaxBounds(bounds);
      map.fitBounds(bounds);
    }
  }, [bounds, map]);
  return null;
}

const Map = ({ filters, onDistrictClick, setDistrictData }) => {
  const [geojson, setGeojson] = useState(null);

  // Границы Якутии
  const yakutiaBounds = [
    [55.5, 105.0],
    [77.0, 165.0]
  ];

  useEffect(() => {
    fetch('/districts.geojson')
      .then(r => r.json())
      .then(data => setGeojson(data))
      .catch(err => console.error('Ошибка GeoJSON:', err));
  }, []);

  const fetchData = async (districtId) => {
    // Твой код для данных из SQLite
  };

  const onEachFeature = (feature, layer) => {
      const props = feature.properties;
      
      // ИЩЕМ ИМЯ ПО ВСЕМ ВОЗМОЖНЫМ СТАНДАРТНЫМ КЛЮЧАМ GEOJSON
      const name = props.district || props.name || props.NAME_2 || props.NAME_1 || 'Неизвестный район';
      const id = props.id || feature.id || name;

      layer.bindPopup(name);
      layer.on('click', () => {
        onDistrictClick({ 
          id: name, // Этот id потом обрабатывается в App.jsx (nameToId)
          name: name 
        });
      });
    };
  return (
    <MapContainer 
      center={[66.0, 129.0]} 
      zoom={5} 
      style={{ height: '100%', width: '100%' }}
      minZoom={4}
      maxZoom={12}
    >
      <TileLayer
        url="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
      />
      <SetBounds bounds={yakutiaBounds} />

      {geojson && <GeoJSON data={geojson} onEachFeature={onEachFeature} style={{ color: '#38bdf8', weight: 1.5, fillColor: '#1e293b', fillOpacity: 0.4 }} />}


    </MapContainer>
  );
};

export default Map;